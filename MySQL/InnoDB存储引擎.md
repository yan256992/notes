## 🐞 InnoDB存储引擎

### InnoDB的体系架构

> InnoDB内部有多个内存块，可以认为这些内存块组成了一个大的内存池，负责如下的工作

- 维护所有进程/线程需要访问的内部数据结构
- 缓存磁盘上的数据，方便快速的读取，同时在对磁盘文件的数据进行修改之前在这里缓存
- 重做日志（redo log）缓冲

<img src="https://gitee.com/yan256992/cloudimages/raw/master/img/image-20210909093906467.png" alt="image-20210909093906467" style="zoom:50%;" />

后台线程的很重要作用是负责刷新内存池中的数据，保证缓冲池的内存缓存的是最新的数据

#### 后台线程

1. Master Thread

该线程主要负责将缓冲池中的数据异步刷新到磁盘，保证数据的一致性，包括脏页的刷新、合并插入缓冲

2. IO Thread

InnoDB存储引擎中使用大量的AIO来处理IO请求，这样可以提高数据库的性能 ，包括write、 read、 insert buffer和log IO thread

3. Purge Thread

事务提交之后，其所使用的的undolog可能不在需要，因此该线程用来回收已经使用并分配的undo页

4. Page Cleaner Thread

作用是将之前版本中的脏页的刷新操作都放到单独的线程中来完成。目的是为了减轻原Master Thread的工作

#### 内存

1. 缓冲池

   InnoDB存储引擎是基于磁盘存储的，并将其中的记录按照页的方式进行管理，因此可将其视为基于磁盘的数据库系统

   <img src="https://gitee.com/yan256992/cloudimages/raw/master/img/image-20210909100033552.png" alt="image-20210909100033552" style="zoom:50%;" />

2. 重做日志缓冲

   InnoDB首先将重做日志信息先放到这个缓冲区，然后按一定的频率将其刷新到重做日志文件

#### CheckPoint技术

缓冲池的设计目的是为了协调CPU速度与磁盘速度的差异，因此页的操作首先是在缓冲池中进行的，那么缓冲池中的数据就会和磁盘中的数据不一样，这就需要将缓冲池中的数据刷新到磁盘，如果每次改变都要进行刷新的话对于数据库的性能影响较大。同时，如果在从缓冲区将数据刷新到磁盘的途中发生了宕机，那么数据就不能恢复了。

为了避免上述问题，当前的事务数据库都采用了`Write Ahead Log`的策略，即**当事务提交的时候，先写重做日志，再修改页的数据**，当由于发生宕机导致数据丢失的时候，通过重做日志来完成数据恢复。这也是ACID中D的要求

